# Contribution Guide

## Project Structure

- `packages/cypress-debugger` - the entry point. It exports `debuggerSupport` and `debuggerPlugin` functions, required for plugin installation and a set of types used in the web application.

- `packages/support` - [Cypress Events](https://docs.cypress.io/api/cypress-api/catalog-of-events) handlers that are responsible for collecting events:

  - cypress steps
  - [rrweb](https://www.npmjs.com/package/rrweb) events
  - network requests using the [HAR generator cypress plugin](https://github.com/NeuraLegion/cypress-har-generator)

- `packages/plugin` - exports a function that attaches [Cypress Plugin Events](https://docs.cypress.io/api/plugins/writing-a-plugin) handlers used inside the `setupNodeEvents` function of the cypress configuration.

Here are collected the browser logs, and created the files with the collected information. The browser logs are accessed using the [Chrome DevTools Protocol](https://chromedevtools.github.io/devtools-protocol/) by connecting to the cypress browser using the remote debugging port. The result files are created in the `dump` folder relative to the cypress config file.

- `meta` - [`RunContextData`](./packages/support/src/cy/runContext.ts) an object with the following fields:

  ```typescript
  {
    spec: string; // spec filename
    test: string[]; // test title
    retryAttempt: number; // https://docs.cypress.io/guides/guides/test-retries
  }
  ```

- `browserLogs` - the browser logs at a moment in time. The data is collected using [chrome-remote-interface](https://www.npmjs.com/package/chrome-remote-interface).

- `pluginMeta` - the data passed down to the optional `meta` field of the `debuggerPlugin` options argument.

### Folder structure

- `packages/cypress-debugger` - the plugin entry point. It exports the `debuggerSupport` and `debuggerPlugin` functions, required for plugin installation and a set of types used in the web application.

- `packages/support` - exports the function that attaches handlers to [Cypress Events](https://docs.cypress.io/api/cypress-api/catalog-of-events). Here are made the following actions: - collect cypress events - collect [rrweb](https://www.npmjs.com/package/rrweb) events and match them with rrweb events - recording network events (using the [HAR generator cypress plugin](https://github.com/NeuraLegion/cypress-har-generator))

- `packages/plugin` - exports a function that attaches [Cypress Plugin Events](https://docs.cypress.io/api/plugins/writing-a-plugin) handlers used inside the `setupNodeEvents` function of the cypress configuration. Here are collected the browser logs, and created the files with the collected information.
  The browser logs are accessed using the [Chrome DevTools Protocol](https://chromedevtools.github.io/devtools-protocol/) by connecting to the cypress browser using the remote debugging port.
  The result files are created in the `dump` folder relative to the cypress config file.
- `apps/web` - the web application.
  The Web application is a basic UI created with [Vite](https://vitejs.dev/), [React](https://react.dev/) and [Typescript](https://www.typescriptlang.org/). It is a tool that helps to analyze the information from the files generated by the plugin. It also serves as an example for plugin integration.
- `packages/eslint-config-custom` - shared [eslint](https://eslint.org/) configuration.

- `packages/tsconfig` - shared [tsconfig](https://www.typescriptlang.org/docs/handbook/tsconfig-json.html).

## Development

Start the packages in development mode

```sh
npm install
npm run dev
```

Runs a few tests

```sh
cd apps/web
npx cypress run --browser chrome
```

## Data Structure

The plugin generates a `json` file for each test into the `dump` folder inside the working directory. Each file contains the following fields:

- `cy` - a list of cypress events. The data is collected from the cypress [`log:added`](https://docs.cypress.io/api/cypress-api/catalog-of-events) event.

- `rr` - a list of [rrweb](https://www.npmjs.com/package/rrweb) records, which represents the mutations in the DOM. The entries are linked to `cy` events on cypress `log:added` and `log:changed` events.

- `har` - an [HTTPArchive(HAR)](http://www.softwareishard.com/blog/har-12-spec/) object, recorded by the [HttpArchive Generator](https://github.com/NeuraLegion/cypress-har-generator).

- `meta` - [`RunContextData`](./packages/support/src/cy/runContext.ts) an object with the following fields:

  ```typescript
  {
    spec: string; // spec filename
    test: string[]; // test title
    retryAttempt: number; // https://docs.cypress.io/guides/guides/test-retries
  }
  ```

- `browserLogs` - the browser logs collected using [chrome-remote-interface](https://www.npmjs.com/package/chrome-remote-interface).

- `pluginMeta` - the data passed down to the optional `meta` field of the `debuggerPlugin` options argument.

## Releasing

The project uses [Changesets](https://github.com/changesets/changesets) to manage releases.

### Beta channel

When you want to do a prerelease, you need to enter prerelease mode. You can do that with the `pre enter <tag>`. The tag that you need to pass is used in versions (e.g. `1.0.0-beta.0`) and for the npm dist tag.

Please check [Changesets Prereleases](https://github.com/changesets/changesets/blob/main/docs/prereleases.md) for reference.

Enter prerelease mode and made the first prerelease

```sh
npx changeset pre enter beta
npx changeset version
git add .
git commit -m "chore: release vX.X.X-beta.X"

npm run publish -- -- beta

git tag "vX.X.X-beta.X"
git push --follow-tags
```

To add another prerelease, run:

```sh
npx changeset version
git add .
git commit -m "Version packages"
npm run publish -- -- beta

git tag "x.x.x-beta.x"
git push --follow-tags
```

To exit the prerelease mode:

```sh
npx changeset pre exit
```

### Latest channel

```sh
npx changeset
# follow screen instructions
npx changeset version
# review the updated files
git add .
git commit -m "chore: release vX.X.X"

npm run publish -- -- latest

git tag "vX.X.X"
git push --follow-tags
# create a new release on github
```

### Localhost

```sh
docker run -it --rm --name verdaccio -p 4873:4873 verdaccio/verdaccio
npm adduser --registry http://localhost:4873
npm login --registry http://localhost:4873
npm_config_registry=http://localhost:4873 npm run publish -- -- latest

# use the new package
npm_config_registry=http://localhost:4873 npm i cypress-debugger  --@currents:registry=http://localhost:4873
```
